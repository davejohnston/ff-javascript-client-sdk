import J from"jwt-decode";import z from"mitt";import{EventSourcePolyfill as B}from"event-source-polyfill";var u;(function(i){i.READY="ready",i.CONNECTED="connected",i.DISCONNECTED="disconnected",i.RECONNECTED="reconnected",i.CHANGED="changed",i.ERROR="error"})(u||(u={}));var P={debug:!1,baseUrl:"https://config.feature-flags.uat.harness.io/api/1.0",eventUrl:"https://event.feature-flags.uat.harness.io/api/1.0",streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},h=(i,...s)=>console.error(`[FF-SDK] ${i}`,...s),C=30*1e3;var G="1.3.0",Y=500,w=globalThis.fetch,q=B,p=!!globalThis.Proxy,A=i=>{let{value:s}=i;try{switch(i.kind.toLowerCase()){case"int":case"number":s=Number(s);break;case"boolean":s=s.toString().toLowerCase()==="true";break;case"json":s=JSON.parse(s);break}}catch(I){h(I)}return s},Q=(i,s,I)=>{let R,b,S,T,m=!0,k=()=>{m=!1},D=()=>{m=!0},o=[],l=z(),E={...P,...I},f=(t,...e)=>{E.debug&&console.debug(`[FF-SDK] ${t}`,...e)},y=t=>{if(m){let e=Date.now();e-t.lastAccessed>Y&&(t.count++,t.lastAccessed=e)}};globalThis.onbeforeunload=()=>{o.length&&globalThis.localStorage&&(k(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(o),D())};let j=async(t,e)=>(await(await w(`${e.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:t,target:s})})).json()).authToken,N=()=>{if(o.length){f("Sending metrics...",{metrics:o,evaluations:c});let t={metricsData:o.map(e=>({timestamp:Date.now(),count:e.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:e.featureIdentifier},{key:"featureName",value:e.featureIdentifier},{key:"variationIdentifier",value:e.variationIdentifier},{key:"target",value:s.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:G}]}))};w(`${I.eventUrl}/metrics/${R}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`},body:JSON.stringify(t)}).then(()=>{o=[]}).catch(e=>{h(e)}).finally(()=>{T=window.setTimeout(N,C)})}else T=window.setTimeout(N,C)},c={},F=function(){return p?new Proxy({},{get(t,e){let a=t[e];if(t.hasOwnProperty(e)){let d=t[e],n=o.find(r=>r.featureIdentifier===e&&d===r.featureValue);n?(n.variationIdentifier=c[e]?.identifier||"",y(n)):o.push({featureIdentifier:e,featureValue:d,variationIdentifier:c[e]?.identifier||"",count:m?1:0,lastAccessed:Date.now()}),f("Metrics event: Flag:",e,"has been read with value:",d,"variationIdentifier:",c[e]?.identifier)}return a}}):{}},g=F();j(i,E).then(t=>{S=t;let e=J(t);if(f("Authenticated",e),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,f("Picking up metrics from previous session")}catch(a){}T=window.setTimeout(N,C),R=e.environment,U().then(()=>{f("Fetch all flags ok",g)}).then(()=>{_()}).then(()=>{f("Event stream ready",{storage:g}),l.emit(u.READY,g),p||Object.keys(g).forEach(a=>{o.push({featureIdentifier:a,featureValue:g[a],variationIdentifier:c[a]?.identifier||"",count:m?1:0,lastAccessed:Date.now()})})}).catch(a=>{l.emit(u.ERROR,a)})}).catch(t=>{h("Authentication error: ",t),l.emit(u.ERROR,t)});let U=async()=>{try{(await(await w(`${E.baseUrl}/client/env/${R}/target/${s.identifier}/evaluations`,{headers:{Authorization:`Bearer ${S}`}})).json()).forEach(a=>{let d=A(a);g[a.flag]=d,c[a.flag]={...a,value:d}})}catch(t){return h("Features fetch operation error: ",t),l.emit(u.ERROR,t),t}},M=async t=>{try{let e=await w(`${E.baseUrl}/client/env/${R}/target/${s.identifier}/evaluations/${t}`,{headers:{Authorization:`Bearer ${S}`}});if(e.ok){let a=await e.json(),d=A(a);if(k(),g[t]=d,c[t]={...a,value:d},D(),l.emit(u.CHANGED,p?new Proxy(a,{get(n,r){if(n.hasOwnProperty(r)&&r==="value"){let v=n.flag,O=a.value,V=o.find($=>$.featureIdentifier===v&&$.featureValue===O);V?(y(V),V.variationIdentifier=c[v]?.identifier||""):o.push({featureIdentifier:v,featureValue:String(O),variationIdentifier:c[v].identifier||"",count:m?1:0,lastAccessed:Date.now()}),f("Metrics event: Flag",r,"has been read with value via stream update",O)}return r==="value"?A(a):a[r]}}):{deleted:a.deleted,flag:a.flag,value:A(a)}),!p){let n=a.flag,r=o.find(v=>v.featureIdentifier===n&&v.featureValue===a.value);r?(y(r),r.variationIdentifier=c[n]?.identifier||""):o.push({featureIdentifier:n,featureValue:String(a.value),variationIdentifier:c[n].identifier||"",count:m?1:0,lastAccessed:Date.now()})}}else l.emit(u.ERROR,e)}catch(e){h("Feature fetch operation error: ",e),l.emit(u.ERROR,e)}},_=()=>{if(!E.streamEnabled){f("Stream is disabled by configuration. Note: Polling is not yet supported");return}b=new q(`${E.baseUrl}/stream`,{headers:{Authorization:`Bearer ${S}`,"API-Key":i}}),b.onopen=t=>{f("Stream connected",t),l.emit(u.CONNECTED)},b.onclose=t=>{f("Stream disconnected"),l.emit(u.DISCONNECTED)},b.onerror=t=>{h("Stream has issue",t),l.emit("error",t)},b.addEventListener("*",t=>{let e=JSON.parse(t.data);switch(f("Received event from stream: ",e),e.event){case"create":setTimeout(()=>M(e.identifier),1e3);break;case"patch":M(e.identifier);break;case"delete":delete g[e.identifier],l.emit(u.CHANGED,{flag:e.identifier,value:void 0,deleted:!0}),f("Evaluation deleted",{message:e,storage:g});break}})},L=(t,e)=>l.on(t,e),H=(t,e)=>{t?l.off(t,e):x()},K=(t,e)=>{let a=g[t];if(!p&&a!==void 0){let d=a,n=t,r=o.find(v=>v.featureIdentifier===n&&v.featureValue===d);r?(y(r),r.variationIdentifier=c[n]?.identifier||""):o.push({featureIdentifier:n,featureValue:d,count:m?1:0,variationIdentifier:c[n].identifier||"",lastAccessed:Date.now()})}return a!==void 0?a:e},x=()=>{f("Closing event stream"),g=F(),c={},clearTimeout(T),l.all.clear(),b.close()};return{on:L,off:H,variation:K,close:x}};export{u as Event,Q as initialize};
//# sourceMappingURL=sdk.esm.js.map
