var y=Object.assign;var V=(n,o,h)=>new Promise((w,p)=>{var b=s=>{try{E(h.next(s))}catch(A){p(A)}},I=s=>{try{E(h.throw(s))}catch(A){p(A)}},E=s=>s.done?w(s.value):Promise.resolve(s.value).then(b,I);E((h=h.apply(n,o)).next())});import q from"jwt-decode";import Q from"mitt";import{EventSourcePolyfill as W}from"event-source-polyfill";var d;(function(n){n.READY="ready",n.CONNECTED="connected",n.DISCONNECTED="disconnected",n.RECONNECTED="reconnected",n.CHANGED="changed",n.ERROR="error"})(d||(d={}));var H={debug:!1,baseUrl:"https://config.feature-flags.uat.harness.io/api/1.0",eventUrl:"https://event.feature-flags.uat.harness.io/api/1.0",streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},C=(n,...o)=>console.error(`[FF-SDK] ${n}`,...o),k=30*1e3;var X="1.3.7",Z=500,D=globalThis.fetch,ee=W,N=!!globalThis.Proxy,F=n=>{let{value:o}=n;try{switch(n.kind.toLowerCase()){case"int":case"number":o=Number(o);break;case"boolean":o=o.toString().toLowerCase()==="true";break;case"json":o=JSON.parse(o);break}}catch(h){C(h)}return o},te=(n,o,h)=>{let w,p,b,I,E,s=!0,A=()=>{s=!1},P=()=>{s=!0},l=[],u=Q(),R=y(y({},H),h),g=(t,...e)=>{R.debug&&console.debug(`[FF-SDK] ${t}`,...e)},O=t=>{if(s){let e=Date.now();e-t.lastAccessed>Z&&(t.count++,t.lastAccessed=e)}};globalThis.onbeforeunload=()=>{l.length&&globalThis.localStorage&&(A(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(l),P())};let K=(t,e)=>V(void 0,null,function*(){return(yield(yield D(`${e.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:t,target:o})})).json()).authToken}),$=()=>{if(l.length){g("Sending metrics...",{metrics:l,evaluations:f});let t={metricsData:l.map(e=>({timestamp:Date.now(),count:e.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:e.featureIdentifier},{key:"featureName",value:e.featureIdentifier},{key:"variationIdentifier",value:e.variationIdentifier},{key:"target",value:o.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:X}]}))};D(`${R.eventUrl}/metrics/${w}?cluster=${p}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${I}`},body:JSON.stringify(t)}).then(()=>{l=[]}).catch(e=>{C(e)}).finally(()=>{E=window.setTimeout($,k)})}else E=window.setTimeout($,k)},f={},j=function(){return N?new Proxy({},{get(t,e){var a,S,c;let i=t[e];if(t.hasOwnProperty(e)){let r=t[e],v=l.find(T=>T.featureIdentifier===e&&r===T.featureValue);v?(v.variationIdentifier=((a=f[e])==null?void 0:a.identifier)||"",O(v)):l.push({featureIdentifier:e,featureValue:r,variationIdentifier:((S=f[e])==null?void 0:S.identifier)||"",count:s?1:0,lastAccessed:Date.now()}),g("Metrics event: Flag:",e,"has been read with value:",r,"variationIdentifier:",(c=f[e])==null?void 0:c.identifier)}return i}}):{}},m=j();K(n,R).then(t=>{I=t;let e=q(t);if(g("Authenticated",e),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,g("Picking up metrics from previous session")}catch(i){}E=window.setTimeout($,k),w=e.environment,p=e.clusterIdentifier,J().then(()=>{g("Fetch all flags ok",m)}).then(()=>{z()}).then(()=>{g("Event stream ready",{storage:m}),u.emit(d.READY,m),N||Object.keys(m).forEach(i=>{var a;l.push({featureIdentifier:i,featureValue:m[i],variationIdentifier:((a=f[i])==null?void 0:a.identifier)||"",count:s?1:0,lastAccessed:Date.now()})})}).catch(i=>{u.emit(d.ERROR,i)})}).catch(t=>{C("Authentication error: ",t),u.emit(d.ERROR,t)});let J=()=>V(void 0,null,function*(){try{(yield(yield D(`${R.baseUrl}/client/env/${w}/target/${o.identifier}/evaluations?cluster=${p}`,{headers:{Authorization:`Bearer ${I}`}})).json()).forEach(i=>{let a=F(i);m[i.flag]=a,f[i.flag]=y(y({},i),{value:a})})}catch(t){return C("Features fetch operation error: ",t),u.emit(d.ERROR,t),t}}),U=t=>V(void 0,null,function*(){var e;try{let i=yield D(`${R.baseUrl}/client/env/${w}/target/${o.identifier}/evaluations/${t}?cluster=${p}`,{headers:{Authorization:`Bearer ${I}`}});if(i.ok){let a=yield i.json(),S=F(a);if(A(),m[t]=S,f[t]=y(y({},a),{value:S}),P(),u.emit(d.CHANGED,N?new Proxy(a,{get(c,r){var v;if(c.hasOwnProperty(r)&&r==="value"){let T=c.flag,M=a.value,x=l.find(L=>L.featureIdentifier===T&&L.featureValue===M);x?(O(x),x.variationIdentifier=((v=f[T])==null?void 0:v.identifier)||""):l.push({featureIdentifier:T,featureValue:String(M),variationIdentifier:f[T].identifier||"",count:s?1:0,lastAccessed:Date.now()}),g("Metrics event: Flag",r,"has been read with value via stream update",M)}return r==="value"?F(a):a[r]}}):{deleted:a.deleted,flag:a.flag,value:F(a)}),!N){let c=a.flag,r=l.find(v=>v.featureIdentifier===c&&v.featureValue===a.value);r?(O(r),r.variationIdentifier=((e=f[c])==null?void 0:e.identifier)||""):l.push({featureIdentifier:c,featureValue:String(a.value),variationIdentifier:f[c].identifier||"",count:s?1:0,lastAccessed:Date.now()})}}else u.emit(d.ERROR,i)}catch(i){C("Feature fetch operation error: ",i),u.emit(d.ERROR,i)}}),z=()=>{if(!R.streamEnabled){g("Stream is disabled by configuration. Note: Polling is not yet supported");return}b=new ee(`${R.baseUrl}/stream`,{headers:{Authorization:`Bearer ${I}`,"API-Key":n}}),b.onopen=t=>{g("Stream connected",t),u.emit(d.CONNECTED)},b.onclose=t=>{g("Stream disconnected"),u.emit(d.DISCONNECTED)},b.onerror=t=>{C("Stream has issue",t),u.emit("error",t)},b.addEventListener("*",t=>{let e=JSON.parse(t.data);switch(g("Received event from stream: ",e),e.event){case"create":setTimeout(()=>U(e.identifier),1e3);break;case"patch":U(e.identifier);break;case"delete":delete m[e.identifier],u.emit(d.CHANGED,{flag:e.identifier,value:void 0,deleted:!0}),g("Evaluation deleted",{message:e,storage:m});break}})},B=(t,e)=>u.on(t,e),G=(t,e)=>{t?u.off(t,e):_()},Y=(t,e)=>{var a;let i=m[t];if(!N&&i!==void 0){let S=i,c=t,r=l.find(v=>v.featureIdentifier===c&&v.featureValue===S);r?(O(r),r.variationIdentifier=((a=f[c])==null?void 0:a.identifier)||""):l.push({featureIdentifier:c,featureValue:S,count:s?1:0,variationIdentifier:f[c].identifier||"",lastAccessed:Date.now()})}return i!==void 0?i:e},_=()=>{g("Closing event stream"),m=j(),f={},clearTimeout(E),u.all.clear(),b.close()};return{on:B,off:G,variation:Y,close:_}};export{d as Event,te as initialize};
//# sourceMappingURL=sdk.esm.js.map
