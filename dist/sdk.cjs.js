var Q=Object.create,C=Object.defineProperty,W=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty,Z=Object.getOwnPropertyNames,ee=Object.getOwnPropertyDescriptor;var U=a=>C(a,"__esModule",{value:!0});var te=(a,n)=>{for(var v in n)C(a,v,{get:n[v],enumerable:!0})},ae=(a,n,v)=>{if(n&&typeof n=="object"||typeof n=="function")for(let m of Z(n))!X.call(a,m)&&m!=="default"&&C(a,m,{get:()=>n[m],enumerable:!(v=ee(n,m))||v.enumerable});return a},D=a=>ae(U(C(a!=null?Q(W(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);U(exports);te(exports,{Event:()=>u,initialize:()=>oe});var L=D(require("jwt-decode")),H=D(require("mitt")),K=D(require("event-source-polyfill"));var u;(function(a){a.READY="ready",a.CONNECTED="connected",a.DISCONNECTED="disconnected",a.RECONNECTED="reconnected",a.CHANGED="changed",a.ERROR="error"})(u||(u={}));var _={debug:!1,baseUrl:"https://config.feature-flags.uat.harness.io/api/1.0",eventUrl:"https://event.feature-flags.uat.harness.io/api/1.0",streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},E=(a,...n)=>console.error(`[FF-SDK] ${a}`,...n),w=30*1e3;var ie="1.3.0",ne=500,A=globalThis.fetch,re=K.EventSourcePolyfill,R=!!globalThis.Proxy,N=a=>{let{value:n}=a;try{switch(a.kind.toLowerCase()){case"int":case"number":n=Number(n);break;case"boolean":n=n.toString().toLowerCase()==="true";break;case"json":n=JSON.parse(n);break}}catch(v){E(v)}return n},oe=(a,n,v)=>{let m,S,I,T,b=!0,F=()=>{b=!1},M=()=>{b=!0},s=[],l=(0,H.default)(),p={..._,...v},f=(t,...e)=>{p.debug&&console.debug(`[FF-SDK] ${t}`,...e)},y=t=>{if(b){let e=Date.now();e-t.lastAccessed>ne&&(t.count++,t.lastAccessed=e)}};globalThis.onbeforeunload=()=>{s.length&&globalThis.localStorage&&(F(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(s),M())};let J=async(t,e)=>(await(await A(`${e.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:t,target:n})})).json()).authToken,O=()=>{if(s.length){f("Sending metrics...",{metrics:s,evaluations:c});let t={metricsData:s.map(e=>({timestamp:Date.now(),count:e.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:e.featureIdentifier},{key:"featureName",value:e.featureIdentifier},{key:"variationIdentifier",value:e.variationIdentifier},{key:"target",value:n.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:ie}]}))};A(`${v.eventUrl}/metrics/${m}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${I}`},body:JSON.stringify(t)}).then(()=>{s=[]}).catch(e=>{E(e)}).finally(()=>{T=window.setTimeout(O,w)})}else T=window.setTimeout(O,w)},c={},x=function(){return R?new Proxy({},{get(t,e){let i=t[e];if(t.hasOwnProperty(e)){let d=t[e],r=s.find(o=>o.featureIdentifier===e&&d===o.featureValue);r?(r.variationIdentifier=c[e]?.identifier||"",y(r)):s.push({featureIdentifier:e,featureValue:d,variationIdentifier:c[e]?.identifier||"",count:b?1:0,lastAccessed:Date.now()}),f("Metrics event: Flag:",e,"has been read with value:",d,"variationIdentifier:",c[e]?.identifier)}return i}}):{}},g=x();J(a,p).then(t=>{I=t;let e=(0,L.default)(t);if(f("Authenticated",e),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,f("Picking up metrics from previous session")}catch(i){}T=window.setTimeout(O,w),m=e.environment,z().then(()=>{f("Fetch all flags ok",g)}).then(()=>{B()}).then(()=>{f("Event stream ready",{storage:g}),l.emit(u.READY,g),R||Object.keys(g).forEach(i=>{s.push({featureIdentifier:i,featureValue:g[i],variationIdentifier:c[i]?.identifier||"",count:b?1:0,lastAccessed:Date.now()})})}).catch(i=>{l.emit(u.ERROR,i)})}).catch(t=>{E("Authentication error: ",t),l.emit(u.ERROR,t)});let z=async()=>{try{(await(await A(`${p.baseUrl}/client/env/${m}/target/${n.identifier}/evaluations`,{headers:{Authorization:`Bearer ${I}`}})).json()).forEach(i=>{let d=N(i);g[i.flag]=d,c[i.flag]={...i,value:d}})}catch(t){return E("Features fetch operation error: ",t),l.emit(u.ERROR,t),t}},$=async t=>{try{let e=await A(`${p.baseUrl}/client/env/${m}/target/${n.identifier}/evaluations/${t}`,{headers:{Authorization:`Bearer ${I}`}});if(e.ok){let i=await e.json(),d=N(i);if(F(),g[t]=d,c[t]={...i,value:d},M(),l.emit(u.CHANGED,R?new Proxy(i,{get(r,o){if(r.hasOwnProperty(o)&&o==="value"){let h=r.flag,V=i.value,k=s.find(j=>j.featureIdentifier===h&&j.featureValue===V);k?(y(k),k.variationIdentifier=c[h]?.identifier||""):s.push({featureIdentifier:h,featureValue:String(V),variationIdentifier:c[h].identifier||"",count:b?1:0,lastAccessed:Date.now()}),f("Metrics event: Flag",o,"has been read with value via stream update",V)}return o==="value"?N(i):i[o]}}):{deleted:i.deleted,flag:i.flag,value:N(i)}),!R){let r=i.flag,o=s.find(h=>h.featureIdentifier===r&&h.featureValue===i.value);o?(y(o),o.variationIdentifier=c[r]?.identifier||""):s.push({featureIdentifier:r,featureValue:String(i.value),variationIdentifier:c[r].identifier||"",count:b?1:0,lastAccessed:Date.now()})}}else l.emit(u.ERROR,e)}catch(e){E("Feature fetch operation error: ",e),l.emit(u.ERROR,e)}},B=()=>{if(!p.streamEnabled){f("Stream is disabled by configuration. Note: Polling is not yet supported");return}S=new re(`${p.baseUrl}/stream`,{headers:{Authorization:`Bearer ${I}`,"API-Key":a}}),S.onopen=t=>{f("Stream connected",t),l.emit(u.CONNECTED)},S.onclose=t=>{f("Stream disconnected"),l.emit(u.DISCONNECTED)},S.onerror=t=>{E("Stream has issue",t),l.emit("error",t)},S.addEventListener("*",t=>{let e=JSON.parse(t.data);switch(f("Received event from stream: ",e),e.event){case"create":setTimeout(()=>$(e.identifier),1e3);break;case"patch":$(e.identifier);break;case"delete":delete g[e.identifier],l.emit(u.CHANGED,{flag:e.identifier,value:void 0,deleted:!0}),f("Evaluation deleted",{message:e,storage:g});break}})},G=(t,e)=>l.on(t,e),Y=(t,e)=>{t?l.off(t,e):P()},q=(t,e)=>{let i=g[t];if(!R&&i!==void 0){let d=i,r=t,o=s.find(h=>h.featureIdentifier===r&&h.featureValue===d);o?(y(o),o.variationIdentifier=c[r]?.identifier||""):s.push({featureIdentifier:r,featureValue:d,count:b?1:0,variationIdentifier:c[r].identifier||"",lastAccessed:Date.now()})}return i!==void 0?i:e},P=()=>{f("Closing event stream"),g=x(),c={},clearTimeout(T),l.all.clear(),S.close()};return{on:G,off:Y,variation:q,close:P}};
//# sourceMappingURL=sdk.cjs.js.map
