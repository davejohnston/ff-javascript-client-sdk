var te=Object.create,V=Object.defineProperty,ie=Object.getPrototypeOf,ae=Object.prototype.hasOwnProperty,ne=Object.getOwnPropertyNames,re=Object.getOwnPropertyDescriptor;var C=Object.assign,J=i=>V(i,"__esModule",{value:!0});var oe=(i,a)=>{for(var u in a)V(i,u,{get:a[u],enumerable:!0})},se=(i,a,u)=>{if(a&&typeof a=="object"||typeof a=="function")for(let m of ne(a))!ae.call(i,m)&&m!=="default"&&V(i,m,{get:()=>a[m],enumerable:!(u=re(a,m))||u.enumerable});return i},j=i=>se(J(V(i!=null?te(ie(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var k=(i,a,u)=>new Promise((m,I)=>{var E=s=>{try{S(u.next(s))}catch(A){I(A)}},R=s=>{try{S(u.throw(s))}catch(A){I(A)}},S=s=>s.done?m(s.value):Promise.resolve(s.value).then(E,R);S((u=u.apply(i,a)).next())});J(exports);oe(exports,{Event:()=>g,initialize:()=>fe});var B=j(require("jwt-decode")),G=j(require("mitt")),Y=j(require("event-source-polyfill"));var g;(function(i){i.READY="ready",i.CONNECTED="connected",i.DISCONNECTED="disconnected",i.RECONNECTED="reconnected",i.CHANGED="changed",i.ERROR="error"})(g||(g={}));var z={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},w=(i,...a)=>console.error(`[FF-SDK] ${i}`,...a),D=30*1e3;var le="1.4.0",ce=500,F=globalThis.fetch,ue=Y.EventSourcePolyfill,N=!!globalThis.Proxy,$=i=>{let{value:a}=i;try{switch(i.kind.toLowerCase()){case"int":case"number":a=Number(a);break;case"boolean":a=a.toString().toLowerCase()==="true";break;case"json":a=JSON.parse(a);break}}catch(u){w(u)}return a},fe=(i,a,u)=>{let m,I,E,R,S,s=!0,A=()=>{s=!1},U=()=>{s=!0},l=[],f=(0,G.default)(),T=C(C({},z),u),v=(t,...e)=>{T.debug&&console.debug(`[FF-SDK] ${t}`,...e)},O=t=>{if(s){let e=Date.now();e-t.lastAccessed>ce&&(t.count++,t.lastAccessed=e)}};globalThis.onbeforeunload=()=>{l.length&&globalThis.localStorage&&(A(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(l),U())};let q=(t,e)=>k(void 0,null,function*(){return(yield(yield F(`${e.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:t,target:a})})).json()).authToken}),M=()=>{if(l.length){v("Sending metrics...",{metrics:l,evaluations:d});let t={metricsData:l.map(e=>({timestamp:Date.now(),count:e.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:e.featureIdentifier},{key:"featureName",value:e.featureIdentifier},{key:"variationIdentifier",value:e.variationIdentifier},{key:"target",value:a.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:le}]}))};F(`${T.eventUrl}/metrics/${m}?cluster=${I}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${R}`},body:JSON.stringify(t)}).then(()=>{l=[]}).catch(e=>{w(e)}).finally(()=>{S=window.setTimeout(M,D)})}else S=window.setTimeout(M,D)},d={},_=function(){return N?new Proxy({},{get(t,e){var r,p,c;let n=t[e];if(t.hasOwnProperty(e)){let o=t[e],h=l.find(y=>y.featureIdentifier===e&&o===y.featureValue);h?(h.variationIdentifier=((r=d[e])==null?void 0:r.identifier)||"",O(h)):l.push({featureIdentifier:e,featureValue:o,variationIdentifier:((p=d[e])==null?void 0:p.identifier)||"",count:s?1:0,lastAccessed:Date.now()}),v("Metrics event: Flag:",e,"has been read with value:",o,"variationIdentifier:",(c=d[e])==null?void 0:c.identifier)}return n}}):{}},b=_();q(i,T).then(t=>{R=t;let e=(0,B.default)(t);if(v("Authenticated",e),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,v("Picking up metrics from previous session")}catch(n){}S=window.setTimeout(M,D),m=e.environment,I=e.clusterIdentifier,Q().then(()=>{v("Fetch all flags ok",b)}).then(()=>{W()}).then(()=>{v("Event stream ready",{storage:b}),f.emit(g.READY,b),N||Object.keys(b).forEach(n=>{var r;l.push({featureIdentifier:n,featureValue:b[n],variationIdentifier:((r=d[n])==null?void 0:r.identifier)||"",count:s?1:0,lastAccessed:Date.now()})})}).catch(n=>{f.emit(g.ERROR,n)})}).catch(t=>{w("Authentication error: ",t),f.emit(g.ERROR,t)});let Q=()=>k(void 0,null,function*(){try{(yield(yield F(`${T.baseUrl}/client/env/${m}/target/${a.identifier}/evaluations?cluster=${I}`,{headers:{Authorization:`Bearer ${R}`}})).json()).forEach(n=>{let r=$(n);b[n.flag]=r,d[n.flag]=C(C({},n),{value:r})})}catch(t){return w("Features fetch operation error: ",t),f.emit(g.ERROR,t),t}}),L=t=>k(void 0,null,function*(){var e;try{let n=yield F(`${T.baseUrl}/client/env/${m}/target/${a.identifier}/evaluations/${t}?cluster=${I}`,{headers:{Authorization:`Bearer ${R}`}});if(n.ok){let r=yield n.json(),p=$(r);if(A(),b[t]=p,d[t]=C(C({},r),{value:p}),U(),f.emit(g.CHANGED,N?new Proxy(r,{get(c,o){var h;if(c.hasOwnProperty(o)&&o==="value"){let y=c.flag,x=r.value,P=l.find(K=>K.featureIdentifier===y&&K.featureValue===x);P?(O(P),P.variationIdentifier=((h=d[y])==null?void 0:h.identifier)||""):l.push({featureIdentifier:y,featureValue:String(x),variationIdentifier:d[y].identifier||"",count:s?1:0,lastAccessed:Date.now()}),v("Metrics event: Flag",o,"has been read with value via stream update",x)}return o==="value"?$(r):r[o]}}):{deleted:r.deleted,flag:r.flag,value:$(r)}),!N){let c=r.flag,o=l.find(h=>h.featureIdentifier===c&&h.featureValue===r.value);o?(O(o),o.variationIdentifier=((e=d[c])==null?void 0:e.identifier)||""):l.push({featureIdentifier:c,featureValue:String(r.value),variationIdentifier:d[c].identifier||"",count:s?1:0,lastAccessed:Date.now()})}}else f.emit(g.ERROR,n)}catch(n){w("Feature fetch operation error: ",n),f.emit(g.ERROR,n)}}),W=()=>{if(!T.streamEnabled){v("Stream is disabled by configuration. Note: Polling is not yet supported");return}E=new ue(`${T.baseUrl}/stream`,{headers:{Authorization:`Bearer ${R}`,"API-Key":i}}),E.onopen=t=>{v("Stream connected",t),f.emit(g.CONNECTED)},E.onclose=t=>{v("Stream disconnected"),f.emit(g.DISCONNECTED)},E.onerror=t=>{w("Stream has issue",t),f.emit("error",t)},E.addEventListener("*",t=>{let e=JSON.parse(t.data);switch(v("Received event from stream: ",e),e.event){case"create":setTimeout(()=>L(e.identifier),1e3);break;case"patch":L(e.identifier);break;case"delete":delete b[e.identifier],f.emit(g.CHANGED,{flag:e.identifier,value:void 0,deleted:!0}),v("Evaluation deleted",{message:e,storage:b});break}})},X=(t,e)=>f.on(t,e),Z=(t,e)=>{t?f.off(t,e):H()},ee=(t,e)=>{var r;let n=b[t];if(!N&&n!==void 0){let p=n,c=t,o=l.find(h=>h.featureIdentifier===c&&h.featureValue===p);o?(O(o),o.variationIdentifier=((r=d[c])==null?void 0:r.identifier)||""):l.push({featureIdentifier:c,featureValue:p,count:s?1:0,variationIdentifier:d[c].identifier||"",lastAccessed:Date.now()})}return n!==void 0?n:e},H=()=>{v("Closing event stream"),b=_(),d={},clearTimeout(S),f.all.clear(),E.close()};return{on:X,off:Z,variation:ee,close:H}};
//# sourceMappingURL=sdk.cjs.js.map
